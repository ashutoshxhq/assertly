import { Inject, Injectable } from '@nestjs/common';
import { PlannerAIDTO } from './dto/planner.dto';
import { LanguageModelService } from '../language-model/language-model.service';
import {
    generateStepsSystemPrompt,
    generateStepsUserPrompt,
} from 'src/common/prompts/generate-steps.prompt';
import { Step } from './dto/step.dto';

@Injectable()
export class AgentService {
    constructor(
        @Inject(LanguageModelService) private llm: LanguageModelService,
    ) {}

    async planSteps(data: PlannerAIDTO) {
        const systemPrompt = generateStepsSystemPrompt();
        const userPrompt = generateStepsUserPrompt(data);
        const res = await this.llm.generate([
            {
                role: 'system',
                content: systemPrompt,
            },
            {
                role: 'user',
                content: userPrompt,
            },
        ]);
        const aiRsponseData = JSON.parse(res.data.message.content);
        if (this.validateSteps(aiRsponseData?.steps)) {
            return {
                status: 'SUCCESS',
                data: {
                    steps: aiRsponseData?.steps,
                    message: aiRsponseData?.message,
                },
            };
        } else {
            return {
                status: 'ERROR',
                message: 'Invalid steps generated by language model.',
            };
        }
    }

    validateSteps(generatedSteps: any) {
        const steps: Step[] = generatedSteps;
        return steps;
    }
}
